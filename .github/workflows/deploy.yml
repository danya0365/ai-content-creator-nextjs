# ============================================
# GitHub Actions - Automatic Deployment
# ============================================
#
# Workflow ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á release branch
# ‡πÅ‡∏•‡∏∞‡∏à‡∏∞:
# 1. Build ‡πÅ‡∏•‡∏∞ Test ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
# 2. SSH ‡πÑ‡∏õ‡∏¢‡∏±‡∏á VPS
# 3. Pull code ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞ restart services
#
# ============================================

name: üöÄ Deploy to Production

# ==========================================
# Trigger
# ==========================================
# Workflow ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠:
# - Push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á release branch
# - ‡∏´‡∏£‡∏∑‡∏≠ Manual trigger (workflow_dispatch)
on:
  push:
    branches:
      - release
  workflow_dispatch:
    # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô manual ‡∏à‡∏≤‡∏Å GitHub UI

# ==========================================
# Environment Variables
# ==========================================
env:
  NODE_VERSION: '20'

# ==========================================
# Jobs
# ==========================================
jobs:
  # ==========================================
  # Job 1: Build & Test
  # ==========================================
  build:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # Step 1: Checkout code
      # ==========================================
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # ==========================================
      # Step 2: Setup Node.js
      # ==========================================
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      # ==========================================
      # Step 3: Install dependencies
      # ==========================================
      - name: üìö Install dependencies
        run: yarn install --frozen-lockfile

      # ==========================================
      # Step 4: Type check
      # ==========================================
      - name: üîç Type check
        run: yarn type-check

      # ==========================================
      # Step 5: Lint
      # ==========================================
      - name: üßπ Lint
        run: yarn lint || echo "Lint warnings found, continuing..."

      # ==========================================
      # Step 6: Build
      # ==========================================
      - name: üèóÔ∏è Build
        run: yarn build
        env:
          # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ env vars ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö build
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # ==========================================
  # Job 2: Deploy to VPS
  # ==========================================
  deploy:
    name: üöÄ Deploy to VPS
    runs-on: ubuntu-latest
    needs: build  # ‡∏£‡∏≠‡πÉ‡∏´‡πâ build job ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    
    steps:
      # ==========================================
      # Step 1: Deploy via SSH
      # ==========================================
      - name: üîê Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          script: |
            echo "============================================"
            echo "üöÄ Starting deployment..."
            echo "============================================"
            
            # Change to app directory
            cd /opt/app/ai-content-creator-nextjs
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin release
            git reset --hard origin/release
            
            # Make scripts executable
            chmod +x scripts/*.sh
            
            # Run deployment script
            echo "üîÑ Running deployment..."
            BUILD_COMMIT_SHA=${{ github.sha }} ./scripts/deploy.sh
            
            echo "============================================"
            echo "‚úÖ Deployment complete!"
            echo "============================================"

      # ==========================================
      # Step 2: Verify deployment
      # ==========================================
      - name: ‚úÖ Verify deployment
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          
          # Health check (optional - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ domain)
          # curl -f https://your-domain.com/api/health || exit 1
          
          echo "Deployment verified!"

  # ==========================================
  # Job 3: Notify (Optional)
  # ==========================================
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()  # ‡∏£‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    
    steps:
      - name: üì¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
